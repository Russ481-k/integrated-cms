---
globs: *.sql,*.ddl
description: 데이터베이스 설계 및 DDL 작성 규칙
---

# 데이터베이스 설계 규칙

## 🗄️ 테이블 명명 규칙

### 기본 원칙
- **단수형** 사용: `SERVICE`, `ADMIN_USER`, `UNIFIED_CONTENT`
- **UPPER_CASE** + **UNDERSCORE** 구분
- **접두사**: 통합 관리 테이블은 `UNIFIED_` 접두사 사용

### 핵심 테이블 구조

#### 1. 서비스 관리
- `SERVICE`: 개별 서비스 정보 및 연결 설정

#### 2. 권한 관리 (RBAC + ABAC)
- `ADMIN_USER`: 관리자 사용자 (UUID 기반)
- `ADMIN_GROUP`: 관리자 그룹 (계층 구조 지원)
- `ADMIN_GROUP_MEMBER`: 그룹 멤버십
- `ROLE`: 역할 정의
- `PERMISSION`: 권한 정의
- `MENU`: 메뉴 구조 (서비스별)

#### 3. 권한 매핑
- `ADMIN_SERVICE_ROLE`: 사용자/그룹-서비스-역할 매핑
- `ADMIN_MENU_PERMISSION`: 사용자/그룹-메뉴 권한 오버라이드

#### 4. 통합 관리
- `UNIFIED_CONTENT`: 통합 콘텐츠 관리 (기존 bbs_article 구조 기반)
- `UNIFIED_ACTIVITY_LOG`: 통합 활동 로그

## 🔧 DDL 작성 표준

### 필수 감사 필드
모든 주요 테이블에 포함:
```sql
CREATED_BY VARCHAR(36) NULL COMMENT '생성자 ID',
CREATED_IP VARCHAR(45) NULL COMMENT '생성자 IP',
CREATED_AT TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '생성 시각',
UPDATED_BY VARCHAR(36) NULL COMMENT '수정자 ID',
UPDATED_IP VARCHAR(45) NULL COMMENT '수정자 IP',
UPDATED_AT TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '수정 시각'
```

### ID 타입 규칙
- **ADMIN_USER.ADMIN_ID**: `VARCHAR(36)` (UUID)
- **기타 모든 테이블 ID**: `int(10) unsigned NOT NULL AUTO_INCREMENT`

### 외래키 제약조건
```sql
FOREIGN KEY (CREATED_BY) REFERENCES ADMIN_USER(ADMIN_ID) ON DELETE SET NULL ON UPDATE CASCADE,
FOREIGN KEY (PARENT_ID) REFERENCES TABLE_NAME(ID) ON DELETE CASCADE ON UPDATE CASCADE
```

### 인덱스 명명 규칙
```sql
INDEX idx_table_column (COLUMN_NAME) COMMENT '용도 설명',
INDEX idx_table_multi_column (COL1, COL2) COMMENT '복합 인덱스 용도',
UNIQUE KEY unique_table_constraint (COL1, COL2) COMMENT '유일성 제약 설명'
```

### CHECK 제약조건 예시
```sql
CHECK (STATUS IN ('ACTIVE', 'INACTIVE', 'MAINTENANCE')) COMMENT '상태 값 제한',
CHECK (END_DATE >= START_DATE) COMMENT '종료일은 시작일보다 이후여야 함',
CHECK (THREAD_DEPTH >= 0) COMMENT '답변 깊이는 0 이상이어야 함'
```

## 📊 성능 최적화 인덱스

### 권한 검증용
```sql
INDEX idx_admin_service_status (ADMIN_ID, SERVICE_ID, STATUS),
INDEX idx_group_service_status (GROUP_ID, SERVICE_ID, STATUS),
INDEX idx_permission_category_resource (PERMISSION_CATEGORY, RESOURCE_TYPE, ACTION_TYPE)
```

### 메뉴 구조용
```sql
INDEX idx_menu_parent_level_order (PARENT_MENU_ID, MENU_LEVEL, MENU_ORDER),
INDEX idx_menu_service_status (SERVICE_ID, STATUS)
```

### 로그 및 감사용
```sql
INDEX idx_log_admin_action_time (ADMIN_ID, ACTION, CREATED_AT),
INDEX idx_log_service_type_time (SERVICE_ID, TARGET_TYPE, CREATED_AT)
```

## 🔐 보안 고려사항

### 암호화 필드
- `DB_CONNECTION_INFO`: AES-256-GCM 암호화 저장
- `PASSWORD`: bcrypt 해시 저장

### 데이터 격리
- **통합 메타 DB**: 통합 API 서버만 접근
- **개별 서비스 DB**: 해당 서비스만 접근

전체 데이터베이스 스키마는 [03-unified-cms-database-design.md](mdc:.cursor/docs/v2/03-unified-cms-database-design.md)를 참조하세요.