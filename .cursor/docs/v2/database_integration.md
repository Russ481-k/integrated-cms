# 통합 CMS v2 데이터베이스 연동 및 권한 검증 구조

## 1. 데이터베이스 연동 구조

### 1.1 전체 구조도

```mermaid
graph TD
    subgraph 통합 데이터베이스
        A[ADMIN_USER<br/>슈퍼관리자] --> B[SERVICE<br/>서비스 정보]
        B --> C[SERVICE_GROUP<br/>권한 그룹]
        C --> D[SERVICE_MEMBER_GROUP<br/>사용자-그룹 매핑]
        D --> E[SERVICE_PERMISSION<br/>권한 정보]
        E --> F[SERVICE_PERMISSION_LOG<br/>권한 변경 이력]
    end

    subgraph 서비스A
        SA[서비스A 관리자] --> S1[사이트1]
        SA --> S2[사이트2]
        S1 --> G1[admin_user<br/>사이트1 관리자]
        S2 --> G2[admin_user<br/>사이트2 관리자]
        G1 --> H1[admin_group<br/>사이트1 그룹]
        G2 --> H2[admin_group<br/>사이트2 그룹]
        H1 --> I1[일반관리자]
        H2 --> I2[일반관리자]
    end

    subgraph 서비스B
        SB[서비스B 관리자] --> S3[사이트3]
        SB --> S4[사이트4]
        S3 --> G3[admin_user<br/>사이트3 관리자]
        S4 --> G4[admin_user<br/>사이트4 관리자]
        G3 --> H3[admin_group<br/>사이트3 그룹]
        G4 --> H4[admin_group<br/>사이트4 그룹]
        H3 --> I3[일반관리자]
        H4 --> I4[일반관리자]
    end

    B --> SA
    B --> SB
```

### 1.2 서비스-사이트 관계

1. 슈퍼관리자
   - 모든 서비스와 사이트에 대한 최고 권한
   - 통합 데이터베이스에서 관리
   - 서비스 및 사이트 생성/관리 권한

2. 서비스관리자
   - 특정 서비스 전체에 대한 관리 권한
   - 해당 서비스의 모든 사이트 관리 가능
   - 사이트 관리자 지정 권한

3. 사이트관리자
   - 특정 사이트에 대한 관리 권한
   - 해당 사이트의 그룹 및 일반관리자 관리
   - 사이트 내 컨텐츠 전체 관리 권한

4. 일반관리자
   - 특정 그룹에 소속
   - 그룹의 기본 권한 보유
   - 추가 권한 보유 가능

### 1.3 데이터베이스 구성

#### 1.3.1 통합 데이터베이스
- ADMIN_USER: 슈퍼관리자와 서비스관리자 정보
- SERVICE: 서비스 및 사이트 정보
- SERVICE_GROUP: 권한 그룹 정보
- SERVICE_MEMBER_GROUP: 사용자-그룹 매핑
- SERVICE_PERMISSION: 권한 정보
- SERVICE_PERMISSION_LOG: 권한 변경 이력

#### 1.3.2 서비스별 데이터베이스
- admin_user: 사이트관리자 및 일반관리자 정보
- admin_group: 그룹 정보
- admin_additional_permission: 추가 권한 정보

## 2. 권한 검증 프로세스

### 2.1 프로세스 흐름도

```mermaid
graph TD
    A[권한 검증 요청] --> B{통합관리자 확인}
    
    B -->|Yes| C{관리자 타입?}
    C -->|슈퍼관리자| D[모든 권한 허용]
    C -->|서비스관리자| E{해당 서비스 확인}
    E -->|Yes| F[서비스 전체 권한 허용]
    E -->|No| G[권한 거부]
    
    B -->|No| H{사이트관리자 확인}
    H -->|Yes| I[해당 사이트 권한 확인]
    I -->|Yes| J[사이트 전체 권한 허용]
    I -->|No| K[권한 거부]
    
    H -->|No| L[일반관리자]
    L --> M[소속 그룹 확인]
    M --> N[그룹 기본 권한 확인]
    N --> O[추가 권한 확인]
    O --> P[최종 권한 결정]
```

### 2.2 시나리오별 권한 검증

1. **납품 시나리오 (예: 대학교)**
   - 슈퍼관리자: 전체 시스템 관리
   - 서비스관리자: 대학 전체 서비스 관리
   - 사이트관리자: 각 학과 사이트 관리
   - 일반관리자: 학과 내 특정 권한 그룹

2. **단일 서비스 다중 사이트 시나리오**
   - 슈퍼관리자: 시스템 총괄
   - 서비스관리자: 서비스 총괄
   - 사이트관리자: 개별 사이트 관리
   - 일반관리자: 사이트 내 그룹별 권한

## 3. 주요 특징

### 3.1 명확한 권한 계층
- 통합관리자와 서비스관리자는 통합 DB 관리
- 사이트관리자와 일반관리자는 서비스 DB 관리
- 계층적 권한 구조로 명확한 책임 구분

### 3.2 유연한 권한 관리
- 서비스별 독립적 관리 가능
- 사이트별 독립적 관리 가능
- 그룹 기반 기본 권한
- 관리자별 추가 권한 가능

### 3.3 효율적인 권한 검증
- 계층적 권한 체크
- 캐시 활용 가능
- 상세한 로깅

### 3.4 보안성
- DB 분리로 보안 강화
- 명확한 접근 제어
- 감사 추적 가능

## 4. 운영 고려사항

### 4.1 성능 최적화
- 권한 캐싱 전략 수립
- 인덱스 최적화
- 주기적 성능 모니터링

### 4.2 데이터 정합성
- 트랜잭션 관리
- 권한 변경 시 동기화
- 에러 처리 및 복구

### 4.3 모니터링
- 권한 검증 로그 분석
- 성능 메트릭 수집
- 이상 징후 탐지