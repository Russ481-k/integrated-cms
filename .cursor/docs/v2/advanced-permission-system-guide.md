# 고도화된 관리자 권한 시스템 완전 설계 가이드

## 1. 시스템 개요

### 1.1 설계 목표

통합 CMS에서는 개별 사이트와 통합 관리 사이트 모두에서 유연하고 세분화된 관리자 권한 관리가 필요합니다. 이를 위해 **RBAC (Role-Based Access Control)** + **ABAC (Attribute-Based Access Control)** 하이브리드 모델을 채택합니다.

### 1.2 핵심 요구사항

#### 1.2.1 개별 사이트 관리자 관리

- 사이트 선택 불가능 (해당 사이트만 관리)
- 사용자 선택 가능
- 메뉴 선택 가능
- 메뉴 내 주요 기능 권한 지정 가능

#### 1.2.2 통합 사이트 관리자 관리

- 사이트 선택 가능 (모든 개별 사이트 + 통합 관리 사이트)
- 사용자 선택 가능
- 메뉴 선택 가능
- 메뉴 내 주요 기능 권한 지정 가능
- 개별 사이트 관리자의 권한까지 설정 가능

### 1.3 권한 모델 구조

```
통합 관리자 (SUPER_ADMIN)
    ├── 개별 서비스 관리 권한
    ├── 통합 시스템 관리 권한
    └── 타 관리자 권한 설정 권한

개별 서비스 관리자 (SERVICE_ADMIN)
    ├── 해당 서비스만 관리 권한
    └── 서비스 내 사용자 권한 설정

일반 관리자 (OPERATOR)
    └── 할당된 메뉴/기능만 접근 권한
```

### 1.4 권한 검증 우선순위

1. **명시적 거부 권한** (DENY) - 최우선, 모든 다른 권한을 무효화
2. **개별 사용자 명시적 허용 권한** (USER ALLOW)
3. **그룹을 통한 허용 권한** (GROUP ALLOW)
4. **역할 기반 기본 권한** (ROLE PERMISSION)
5. **기본 거부** (권한 없음)

## 2. 데이터베이스 설계

### 2.1 핵심 테이블 구조 요약

권한 시스템의 핵심 테이블들과 그 관계는 다음과 같습니다:

- **admin_users**: 관리자 기본 정보
- **admin_groups**: 관리자 그룹 (부서, 프로젝트, 커스텀)
- **admin_group_members**: 그룹 멤버십
- **roles**: 역할 정의
- **permissions**: 권한 정의
- **role_permissions**: 역할-권한 매핑
- **menus**: 메뉴 구조 정의
- **admin_service_roles**: 사용자-서비스-역할 매핑
- **admin_menu_permissions**: 메뉴별 세부 권한
- **permission_audit_logs**: 권한 변경 감사 로그

### 2.2 데이터베이스 설계 원칙

- **확장성**: 새로운 서비스와 권한 추가가 용이
- **성능**: 권한 검증이 빠르게 수행됨
- **보안**: 최소 권한 원칙과 명시적 거부 우선 적용
- **감사**: 모든 권한 변경사항이 추적 가능
- **재사용성**: 개별 사이트에서도 동일한 구조 적용 가능

_상세한 DDL은 [advanced-permission-database-design.md](./advanced-permission-database-design.md)를 참조하세요._

## 3. 권한 검증 로직

### 3.1 권한 검증 플로우

#### 3.1.1 1단계: 캐시 확인

- Redis를 활용한 권한 결과 캐싱 (TTL: 15분)
- 캐시 키 패턴: `permission:{adminId}:{serviceCode}:{permissionCode}`
- 캐시 히트 시 즉시 결과 반환

#### 3.1.2 2단계: 명시적 거부 권한 검사

- 사용자별/그룹별 명시적 DENY 권한 확인
- DENY 권한 발견 시 즉시 접근 거부
- 최고 우선순위 적용

#### 3.1.3 3단계: 명시적 허용 권한 검사

- 사용자별 명시적 ALLOW 권한 확인
- 그룹을 통한 ALLOW 권한 확인
- 명시적 허용 시 즉시 접근 허용

#### 3.1.4 4단계: 역할 기반 권한 검사

- 할당된 역할의 기본 권한 확인
- 서비스별 역할 할당 상태 검증
- 권한 만료 시간 확인

#### 3.1.5 5단계: 기본 거부

- 모든 조건 만족하지 않을 시 접근 거부
- 최소 권한 원칙 적용

### 3.2 메뉴 접근 권한 검증

#### 3.2.1 메뉴 정보 검증

- 메뉴 존재 여부 확인
- 메뉴 활성화 상태 확인
- 서비스별 메뉴 소속 확인

#### 3.2.2 메뉴별 명시적 권한 검사

- admin_menu_permissions 테이블 조회
- DENY 권한 우선 검사
- ALLOW 권한 확인

#### 3.2.3 메뉴 필수 권한 검사

- required_permissions JSON 필드 파싱
- 필수 권한 모두 보유 확인
- AND 조건으로 모든 권한 확인

### 3.3 세부 기능 권한 검증

#### 3.3.1 기본 메뉴 접근 권한 선행 확인

- 메뉴 접근 권한 없을 시 즉시 거부

#### 3.3.2 기능별 세부 권한 검사

- specific_permissions JSON 필드 확인
- 기능별 DENY/ALLOW 권한 검증
- 역할 기반 기본 기능 권한 확인

## 4. API 설계

### 4.1 REST API 구조

#### 4.1.1 관리자 관리 API

```
GET    /api/unified/admin/users                    # 관리자 목록 조회
POST   /api/unified/admin/users                    # 관리자 생성
GET    /api/unified/admin/users/{adminId}          # 관리자 상세 조회
PUT    /api/unified/admin/users/{adminId}          # 관리자 정보 수정
DELETE /api/unified/admin/users/{adminId}          # 관리자 삭제
```

#### 4.1.2 역할 및 권한 관리 API

```
POST   /api/unified/admin/users/{adminId}/service-roles           # 서비스별 역할 할당
DELETE /api/unified/admin/users/{adminId}/service-roles/{roleId}  # 역할 해제
POST   /api/unified/admin/users/{adminId}/menu-permissions        # 메뉴별 세부 권한 설정
GET    /api/unified/admin/users/{adminId}/accessible-services     # 접근 가능한 서비스 목록
GET    /api/unified/admin/users/{adminId}/menu-tree              # 사용자별 메뉴 트리
```

#### 4.1.3 그룹 관리 API

```
GET    /api/unified/admin/groups                           # 그룹 목록 조회
POST   /api/unified/admin/groups                           # 그룹 생성
POST   /api/unified/admin/groups/{groupId}/members         # 그룹에 관리자 추가
DELETE /api/unified/admin/groups/{groupId}/members/{adminId} # 그룹에서 관리자 제거
```

#### 4.1.4 권한 검증 API

```
POST   /api/unified/auth/verify-permission         # 권한 검증
POST   /api/unified/auth/verify-menu-access        # 메뉴 접근 권한 검증
POST   /api/unified/auth/verify-function-permission # 기능별 권한 검증
```

### 4.2 인증 및 인가 처리

#### 4.2.1 JWT 토큰 기반 인증

- Bearer 토큰을 통한 API 접근 제어
- 토큰에 관리자 ID, 역할, 만료 시간 포함
- Refresh Token을 통한 토큰 갱신

#### 4.2.2 Spring Security 통합

- @PreAuthorize 어노테이션을 통한 메소드 레벨 보안
- 커스텀 PermissionEvaluator 구현
- SecurityContext를 통한 현재 사용자 정보 접근

#### 4.2.3 API Gateway 레벨 인증

- 모든 API 요청에 대한 토큰 검증
- 서비스별 라우팅 전 권한 확인
- 권한 없는 요청에 대한 즉시 차단

### 4.3 응답 데이터 구조

#### 4.3.1 표준 응답 포맷

```json
{
  "status": 200,
  "message": "Success",
  "data": {
    // 실제 데이터
  },
  "timestamp": "2024-01-15T10:30:00Z",
  "requestId": "req-12345"
}
```

#### 4.3.2 오류 응답 포맷

```json
{
  "status": 403,
  "message": "Insufficient permissions",
  "error": {
    "code": "PERMISSION_DENIED",
    "details": "Admin does not have ADMIN_MANAGE permission"
  },
  "timestamp": "2024-01-15T10:30:00Z",
  "requestId": "req-12345"
}
```

## 5. 프론트엔드 설계

### 5.1 컴포넌트 구조

#### 5.1.1 권한 기반 UI 렌더링

- 사용자 권한에 따른 메뉴 동적 생성
- 기능별 버튼/링크 조건부 렌더링
- 권한 없는 페이지 접근 시 적절한 안내 메시지

#### 5.1.2 관리자 관리 페이지 구성

- **관리자 목록**: 검색, 필터링, 페이징 기능
- **권한 설정 모달**: 서비스별/메뉴별 권한 설정 UI
- **그룹 관리**: 계층적 그룹 구조 트리뷰
- **감사 로그**: 권한 변경 이력 조회

#### 5.1.3 권한 매트릭스 컴포넌트

- 행: 관리자/그룹, 열: 서비스/메뉴
- 체크박스를 통한 직관적인 권한 설정
- 일괄 선택/해제 기능
- 권한 상속 관계 시각화

### 5.2 상태 관리

#### 5.2.1 전역 상태 관리

- React Query를 통한 서버 상태 관리
- 권한 정보 캐싱 및 자동 갱신
- 낙관적 업데이트를 통한 UX 향상

#### 5.2.2 권한 정보 캐싱

- 로그인 시 사용자 권한 정보 로드
- 메뉴 트리 및 접근 가능 서비스 캐싱
- 권한 변경 시 관련 캐시 무효화

### 5.3 사용자 경험 고려사항

#### 5.3.1 로딩 상태 관리

- 권한 검증 중 스켈레톤 UI 표시
- 권한 설정 변경 시 로딩 인디케이터
- 비동기 작업의 적절한 피드백

#### 5.3.2 오류 처리

- 권한 없는 접근 시 친화적인 오류 메시지
- 네트워크 오류 시 재시도 옵션 제공
- 폼 검증 오류의 명확한 안내

#### 5.3.3 접근성 고려

- 키보드 네비게이션 지원
- 스크린 리더 호환성
- 색상에 의존하지 않는 UI 디자인

## 6. 관리자 관리 기능

### 6.1 관리자 계정 관리

#### 6.1.1 관리자 생성 프로세스

1. **중복성 검증**: 사용자명, 이메일 중복 확인
2. **비밀번호 암호화**: bcrypt 해싱 적용
3. **기본 정보 설정**: 부서, 직책, 시간대, 언어 설정
4. **초기 상태 설정**: PENDING_APPROVAL 상태로 생성
5. **기본 그룹 할당**: 필요 시 기본 그룹에 자동 추가
6. **감사 로그 기록**: 생성 작업 로그 남김

#### 6.1.2 관리자 상태 관리

- **ACTIVE**: 정상 활성 상태
- **INACTIVE**: 비활성 상태 (로그인 불가)
- **LOCKED**: 계정 잠금 상태 (로그인 실패 횟수 초과)
- **PENDING_APPROVAL**: 승인 대기 상태

#### 6.1.3 보안 정책

- 연속 로그인 실패 시 계정 임시 잠금
- 비밀번호 변경 주기 관리
- 세션 타임아웃 설정
- 2FA 지원 (선택사항)

### 6.2 서비스별 역할 할당

#### 6.2.1 역할 할당 규칙

- 관리자당 서비스별로 하나의 주 역할 할당
- 역할 중복 할당 방지
- 역할 레벨 기반 상하 관계 확인
- 권한 만료 시간 설정 가능

#### 6.2.2 할당 타입

- **개별 할당**: 특정 관리자에게 직접 역할 할당
- **그룹 할당**: 그룹을 통한 역할 상속
- **임시 할당**: 기간 제한이 있는 역할 할당

#### 6.2.3 권한 상속 구조

```
통합 시스템 권한 (service_id = NULL)
    ├── 모든 개별 서비스 접근 가능
    └── 타 관리자 권한 설정 가능

개별 서비스 권한 (service_id = specific)
    ├── 해당 서비스만 접근 가능
    └── 서비스 내 사용자 권한 설정 가능
```

### 6.3 메뉴별 세부 권한 설정

#### 6.3.1 권한 설정 범위

- **FULL**: 메뉴의 모든 기능 접근 가능
- **PARTIAL**: 지정된 기능만 접근 가능
- **READ_ONLY**: 조회만 가능

#### 6.3.2 세부 기능 권한

- **create**: 생성 권한
- **read**: 조회 권한
- **update**: 수정 권한
- **delete**: 삭제 권한
- **publish**: 발행 권한
- **approve**: 승인 권한

#### 6.3.3 조건부 권한

- SpEL 표현식을 통한 동적 권한 제어
- 시간, 사용자 속성, 데이터 상태에 따른 권한 변경
- 예: `#admin.department == 'IT' and #content.status != 'PUBLISHED'`

### 6.4 그룹 관리

#### 6.4.1 그룹 유형

- **SYSTEM**: 시스템 기본 그룹 (삭제 불가)
- **DEPARTMENT**: 부서별 그룹
- **PROJECT**: 프로젝트별 그룹
- **CUSTOM**: 커스텀 그룹

#### 6.4.2 계층적 그룹 구조

- 상위 그룹의 권한 자동 상속
- 그룹 레벨을 통한 계층 관리
- 순환 참조 방지 검증

#### 6.4.3 멤버십 관리

- **OWNER**: 그룹 소유자 (그룹 설정 변경 가능)
- **ADMIN**: 그룹 관리자 (멤버 추가/제거 가능)
- **MEMBER**: 일반 멤버 (권한만 상속)

## 7. 성능 최적화 전략

### 7.1 캐싱 전략

#### 7.1.1 권한 결과 캐싱

- Redis를 통한 권한 검증 결과 캐싱
- 캐시 TTL: 15분 (권한 변경 빈도 고려)
- 캐시 무효화: 권한 변경 시 관련 캐시 즉시 삭제

#### 7.1.2 메뉴 구조 캐싱

- 서비스별 메뉴 트리 구조 캐싱
- 메뉴 변경 시에만 캐시 무효화
- JSON 형태로 직렬화하여 캐싱

#### 7.1.3 역할 권한 매핑 캐싱

- 역할별 권한 목록 캐싱
- 역할 권한 변경 시 캐시 무효화
- 메모리 기반 로컬 캐시와 Redis 조합 사용

### 7.2 데이터베이스 최적화

#### 7.2.1 인덱스 최적화

- 권한 검증 쿼리에 필요한 복합 인덱스 생성
- 카디널리티가 높은 컬럼 우선 배치
- 사용 빈도가 낮은 인덱스 정기적 검토

#### 7.2.2 쿼리 최적화

- N+1 문제 방지를 위한 페치 조인 사용
- 서브쿼리 대신 EXISTS 절 활용
- 배치 권한 검증을 위한 IN 절 최적화

#### 7.2.3 파티셔닝

- 대용량 로그 테이블의 월별 파티셔닝
- 히스토리 데이터의 아카이빙 정책
- 읽기 전용 복제본을 통한 조회 성능 향상

### 7.3 애플리케이션 최적화

#### 7.3.1 권한 검증 배치 처리

- 여러 권한을 한 번에 검증하는 배치 API
- 불필요한 권한 검증 호출 최소화
- 권한 검증 결과의 애플리케이션 레벨 캐싱

#### 7.3.2 비동기 처리

- 권한 변경 시 비동기 캐시 무효화
- 감사 로그 비동기 기록
- 이벤트 드리븐 아키텍처 적용

#### 7.3.3 메모리 최적화

- 권한 객체의 경량화
- 불필요한 데이터 로딩 방지
- 커넥션 풀 최적화

## 8. 보안 고려사항

### 8.1 권한 누수 방지

#### 8.1.1 최소 권한 원칙

- 기본적으로 모든 접근 거부
- 명시적 권한 부여 시에만 접근 허용
- 불필요한 권한 자동 회수

#### 8.1.2 권한 분리

- 읽기 권한과 쓰기 권한 분리
- 일반 작업 권한과 관리 권한 분리
- 민감한 데이터 접근 권한 별도 관리

#### 8.1.3 시간 제한 권한

- 임시 권한의 자동 만료
- 장기간 미사용 권한 자동 회수
- 정기적인 권한 검토 프로세스

### 8.2 감사 및 모니터링

#### 8.2.1 모든 권한 변경 로깅

- 권한 부여/회수 모든 작업 기록
- 작업자, 대상, 시간, 이유 상세 기록
- 변경 전후 상태 비교 저장

#### 8.2.2 이상 행위 탐지

- 비정상적인 권한 접근 패턴 탐지
- 권한 남용 시도 모니터링
- 실시간 알림 시스템

#### 8.2.3 정기 감사

- 권한 할당 현황 정기 검토
- 미사용 권한 정리
- 과도한 권한 보유자 식별

### 8.3 데이터 보호

#### 8.3.1 민감 정보 암호화

- 개인정보 필드 암호화 저장
- 데이터베이스 접속 정보 암호화
- 로그에서 민감 정보 마스킹

#### 8.3.2 접근 제어

- 데이터베이스 레벨 접근 제어
- 네트워크 레벨 보안 (방화벽, VPN)
- 애플리케이션 레벨 인증/인가

## 9. 구현 가이드라인

### 9.1 개발 단계별 접근

#### 9.1.1 Phase 1: 기본 인프라

1. 데이터베이스 스키마 구축
2. 기본 엔티티 및 리포지토리 구현
3. 인증/인가 기본 구조 설정

#### 9.1.2 Phase 2: 핵심 기능

1. 권한 검증 서비스 구현
2. 관리자 관리 기본 기능
3. 역할 및 권한 할당 기능

#### 9.1.3 Phase 3: 고급 기능

1. 메뉴별 세부 권한 관리
2. 그룹 기반 권한 상속
3. 권한 감사 및 모니터링

#### 9.1.4 Phase 4: 최적화 및 확장

1. 성능 최적화 (캐싱, 인덱싱)
2. 프론트엔드 고도화
3. 개별 사이트 적용

### 9.2 테스트 전략

#### 9.2.1 단위 테스트

- 권한 검증 로직 테스트
- 데이터베이스 레이어 테스트
- 비즈니스 로직 테스트

#### 9.2.2 통합 테스트

- API 엔드포인트 테스트
- 권한 흐름 전체 테스트
- 캐시 동작 테스트

#### 9.2.3 E2E 테스트

- 사용자 시나리오 기반 테스트
- 권한 변경 플로우 테스트
- 여러 서비스 간 권한 연동 테스트

### 9.3 모니터링 및 운영

#### 9.3.1 메트릭 수집

- 권한 검증 횟수 및 응답 시간
- 권한 변경 빈도
- 캐시 히트율

#### 9.3.2 알림 설정

- 권한 남용 의심 활동
- 시스템 오류 및 성능 저하
- 보안 정책 위반 사항

#### 9.3.3 정기 감사

- 권한 할당 현황 검토
- 미사용 권한 정리
- 보안 정책 준수 확인

## 10. 개별 사이트 적용 방안

### 10.1 스키마 재사용

#### 10.1.1 테이블 구조 표준화

- 통합 DB와 동일한 테이블 구조 사용
- service_id를 통한 권한 범위 제한
- 로컬 관리자와 통합 관리자 구분

#### 10.1.2 권한 동기화

- 통합 DB에서 개별 사이트로 권한 동기화
- 실시간 또는 배치 방식 선택 가능
- 충돌 해결 정책 정의

### 10.2 독립적 운영

#### 10.2.1 로컬 권한 관리

- 개별 사이트별 독립적인 권한 설정
- 통합 관리자의 원격 권한 관리
- 로컬 관리자의 제한적 권한 관리

#### 10.2.2 보안 격리

- 사이트 간 권한 정보 격리
- 각 사이트별 별도 암호화 키
- 네트워크 레벨 격리 정책

## 11. 주요 특징 요약

### 11.1 세분화된 권한 제어

- **사용자별**: 개별 사용자에게 직접 권한 부여
- **그룹별**: 그룹을 통한 권한 상속
- **메뉴별**: 메뉴 접근 및 기능별 세부 권한
- **서비스별**: 통합 관리와 개별 서비스 권한 분리

### 11.2 계층적 권한 구조

- **명시적 거부 우선**: 보안을 위한 거부 권한 최우선 처리
- **권한 상속**: 그룹 → 사용자, 역할 → 권한의 계층적 상속
- **권한 만료**: 시간 제한이 있는 권한 설정 가능

### 11.3 성능 최적화

- **Redis 캐싱**: 권한 조회 결과 캐싱으로 성능 향상
- **캐시 무효화**: 권한 변경 시 관련 캐시 자동 무효화
- **지연 로딩**: 필요한 권한만 조회하는 최적화

### 11.4 관리 편의성

- **직관적인 UI**: 트리 구조의 메뉴 권한 관리
- **일괄 처리**: 여러 사용자/그룹에 대한 일괄 권한 설정
- **권한 복사**: 기존 사용자의 권한을 다른 사용자에게 복사

이 설계를 통해 통합 CMS에서 요구되는 모든 권한 관리 기능을 구조적으로 완전하게 구현할 수 있으며, 개별 사이트에서도 동일한 수준의 권한 관리 기능을 제공할 수 있습니다.
