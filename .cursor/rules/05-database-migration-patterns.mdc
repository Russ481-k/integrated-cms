---
globs: *.sql,*.java,*.ts
description: v1ì—ì„œ v2ë¡œ ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ë° ë™ì  ë°ì´í„°ì†ŒìŠ¤ íŒ¨í„´
---

# ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ë° ë™ì  ë°ì´í„°ì†ŒìŠ¤ íŒ¨í„´

## ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡° ì„¤ê³„

### í†µí•© ë©”íƒ€ DB ìŠ¤í‚¤ë§ˆ

ê¸°ë³¸ ìŠ¤í‚¤ë§ˆëŠ” [database_schema.sql](mdc:.cursor/docs/v2/database_schema.sql)ì„ ì°¸ì¡°í•˜ì„¸ìš”.

```sql
-- í•µì‹¬ í…Œì´ë¸” êµ¬ì¡°
USE integrated_cms;

-- ê´€ë¦¬ì ì‚¬ìš©ì (ê¸°ì¡´ user í…Œì´ë¸” í™•ì¥)
CREATE TABLE ADMIN_USER (
    UUID VARCHAR(36) PRIMARY KEY,
    USERNAME VARCHAR(50) NOT NULL UNIQUE,
    PASSWORD VARCHAR(255) NOT NULL,
    ROLE VARCHAR(20) NOT NULL, -- SYSTEM_ADMIN, SERVICE_ADMIN, USER
    EMAIL VARCHAR(100) NOT NULL,
    STATUS VARCHAR(20) DEFAULT 'ACTIVE',
    -- ê°ì‚¬ í•„ë“œ
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- ì„œë¹„ìŠ¤ ì •ë³´
CREATE TABLE SERVICE (
    SERVICE_ID VARCHAR(50) PRIMARY KEY,
    SERVICE_NAME VARCHAR(100) NOT NULL,
    DB_CONNECTION_INFO TEXT NOT NULL, -- AES-256 ì•”í˜¸í™”ëœ ì—°ê²° ì •ë³´
    STATUS VARCHAR(20) DEFAULT 'ACTIVE',
    -- ê°ì‚¬ í•„ë“œ
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ê´€ë¦¬ì-ì„œë¹„ìŠ¤ ë§¤í•‘
CREATE TABLE ADMIN_SERVICE_ROLE (
    UUID VARCHAR(36) PRIMARY KEY,
    ADMIN_UUID VARCHAR(36) NOT NULL,
    SERVICE_ID VARCHAR(50) NOT NULL,
    ROLE VARCHAR(20) NOT NULL, -- SERVICE_ADMIN, USER
    FOREIGN KEY (ADMIN_UUID) REFERENCES ADMIN_USER(UUID),
    FOREIGN KEY (SERVICE_ID) REFERENCES SERVICE(SERVICE_ID)
);
```

### ì„œë¹„ìŠ¤ë³„ DB ìŠ¤í‚¤ë§ˆ (ê¸°ì¡´ êµ¬ì¡° ìœ ì§€)

```sql
-- ê° ì„œë¹„ìŠ¤ DB (ì˜ˆ: douzone, service1, service2)
-- ê¸°ì¡´ CMS í…Œì´ë¸” êµ¬ì¡° ê·¸ëŒ€ë¡œ ìœ ì§€

-- ì‚¬ìš©ì í…Œì´ë¸” (ê¸°ì¡´)
CREATE TABLE user (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    email VARCHAR(100) NOT NULL,
    -- ê¸°ì¡´ í•„ë“œë“¤ ìœ ì§€
);

-- ì½˜í…ì¸  í…Œì´ë¸” (ê¸°ì¡´)
CREATE TABLE content (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    content TEXT,
    status VARCHAR(20) DEFAULT 'DRAFT',
    -- ê¸°ì¡´ í•„ë“œë“¤ ìœ ì§€
);
```

## ğŸ”§ ë™ì  ë°ì´í„°ì†ŒìŠ¤ êµ¬í˜„

### 1. ë°ì´í„°ì†ŒìŠ¤ ì„¤ì •

```java
@Configuration
public class DynamicDataSourceConfiguration {

    @Primary
    @Bean
    public DataSource dataSource() {
        return new DynamicRoutingDataSource();
    }

    @Bean
    public DataSource integratedCmsDataSource() {
        HikariConfig config = new HikariConfig();
        config.setJdbcUrl("jdbc:mysql://localhost:3306/integrated_cms");
        config.setUsername("integrated.admin");
        config.setPassword(getDecryptedPassword("integrated_cms_password"));
        return new HikariDataSource(config);
    }

        // ë™ì  ë°ì´í„°ì†ŒìŠ¤ ë¼ìš°íŒ…
    public static class DynamicRoutingDataSource extends AbstractRoutingDataSource {

        private final Map<String, DataSource> dataSourceCache = new ConcurrentHashMap<>();
        private final ServiceRepository serviceRepository;
        private final DatabaseConnectionService connectionService;

        @Override
        protected Object determineCurrentLookupKey() {
            return ServiceContextHolder.getCurrentServiceId();
        }

        @Override
        protected DataSource determineTargetDataSource() {
            String serviceId = ServiceContextHolder.getCurrentServiceId();

            if ("integrated_cms".equals(serviceId) || serviceId == null) {
                return getResolvedDataSource("integrated_cms");
            }

            // ì„œë¹„ìŠ¤ë³„ DB ì—°ê²° ì •ë³´ ì¡°íšŒ ë° DataSource ìƒì„±
            return getOrCreateServiceDataSource(serviceId);
        }

        private DataSource getOrCreateServiceDataSource(String serviceId) {
            // ìºì‹œì—ì„œ DataSource í™•ì¸
            DataSource cachedDataSource = dataSourceCache.get(serviceId);
            if (cachedDataSource != null) {
                return cachedDataSource;
            }

            // integrated_cmsì—ì„œ ì„œë¹„ìŠ¤ ì •ë³´ ì¡°íšŒ
            ServiceEntity service = serviceRepository.findByServiceId(serviceId);
            if (service == null) {
                throw new ServiceNotFoundException("Service not found: " + serviceId);
            }

            // ì•”í˜¸í™”ëœ ì—°ê²° ì •ë³´ ë³µí˜¸í™”
            DatabaseConnectionInfo connectionInfo = connectionService.decryptConnectionInfo(service.getDbConnectionInfo());

            // ìƒˆ DataSource ìƒì„±
            HikariConfig config = new HikariConfig();
            config.setJdbcUrl(connectionInfo.getJdbcUrl());
            config.setUsername(connectionInfo.getUsername());
            config.setPassword(connectionInfo.getPassword());
            config.setMaximumPoolSize(10);
            config.setMinimumIdle(2);

            DataSource dataSource = new HikariDataSource(config);
            dataSourceCache.put(serviceId, dataSource);

            return dataSource;
        }
    }
}
```

### 2. ì„œë¹„ìŠ¤ ì»¨í…ìŠ¤íŠ¸ ê´€ë¦¬

```java
public final class ServiceContextHolder {
    private static final ThreadLocal<String> CONTEXT = new ThreadLocal<>();

    public static void setCurrentServiceId(String serviceId) {
        CONTEXT.set(serviceId);
    }

    public static String getCurrentServiceId() {
        return CONTEXT.get();
    }

    public static void clear() {
        CONTEXT.remove();
    }
}

// URL í”„ë¦¬í”½ìŠ¤ ê¸°ë°˜ ì„œë¹„ìŠ¤ ì»¨í…ìŠ¤íŠ¸ ì£¼ì…
@Component
public class ServiceContextInterceptor implements HandlerInterceptor {

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
        String path = request.getRequestURI();

        if (path.startsWith("/api/v2/integrated-cms/")) {
            ServiceContextHolder.setCurrentServiceId("integrated_cms");
        } else if (path.startsWith("/api/v2/cms/douzone/")) {
            ServiceContextHolder.setCurrentServiceId("douzone");
        } else if (path.startsWith("/api/v2/cms/service1/")) {
            ServiceContextHolder.setCurrentServiceId("service1");
        } else if (path.startsWith("/api/v2/cms/service2/")) {
            ServiceContextHolder.setCurrentServiceId("service2");
        }
        // Note: /api/v2/integrated-cms/** ëŠ” "integrated_cms" DBë¡œ ë¼ìš°íŒ…
        // /api/v2/cms/{serviceId}/** ëŠ” ê° ì„œë¹„ìŠ¤ë³„ DBë¡œ ë™ì  ë¼ìš°íŒ…

        return true;
    }

    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) {
        ServiceContextHolder.clear();
    }
}
```

### 3. ê¸°ì¡´ Service Layer ì¬ì‚¬ìš©

```java
@Service
@Transactional
public class ContentService {

    @Autowired
    private ContentRepository contentRepository;

    // ê¸°ì¡´ ë©”ì„œë“œë“¤ ê·¸ëŒ€ë¡œ ìœ ì§€
    // ServiceContextHolderì— ì˜í•´ ìë™ìœ¼ë¡œ ì ì ˆí•œ DBì— ì—°ê²°ë¨
    public Page<ContentDto> getAllContents(Pageable pageable) {
        Page<Content> contents = contentRepository.findAll(pageable);
        return contents.map(this::convertToDto);
    }

    public ContentDto createContent(ContentDto dto) {
        Content content = convertToEntity(dto);
        Content saved = contentRepository.save(content);
        return convertToDto(saved);
    }
}
```

## ğŸ“Š ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì „ëµ

### 1. ê¸°ì¡´ ë°ì´í„° ë¶„ì„ ë° ë§¤í•‘

```sql
-- ê¸°ì¡´ ì‚¬ìš©ì ë°ì´í„°ë¥¼ ADMIN_USERë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜
INSERT INTO integrated_cms.ADMIN_USER (
    UUID, USERNAME, PASSWORD, EMAIL, ROLE, STATUS, CREATED_AT
)
SELECT
    UUID() as UUID,
    username,
    password,
    email,
    CASE
        WHEN role = 'SUPER_ADMIN' THEN 'SYSTEM_ADMIN'
        WHEN role = 'ADMIN' THEN 'SERVICE_ADMIN'
        ELSE 'USER'
    END as ROLE,
    'ACTIVE' as STATUS,
    created_at
FROM legacy_cms.user
WHERE role IN ('SUPER_ADMIN', 'ADMIN', 'MANAGER');
```

### 2. ì„œë¹„ìŠ¤ ì •ë³´ ë“±ë¡

```sql
-- ì„œë¹„ìŠ¤ ì •ë³´ ë“±ë¡
INSERT INTO integrated_cms.SERVICE (
    SERVICE_ID, SERVICE_NAME, DB_CONNECTION_INFO, STATUS
) VALUES (
    'douzone',
    'ë‘ì¡´ CMS',
    AES_ENCRYPT('{"jdbcUrl":"jdbc:mysql://localhost:3306/douzone","username":"admin","password":"admin123"}', 'encryption_key'),
    'ACTIVE'
);
```

### 3. ì ì§„ì  ë§ˆì´ê·¸ë ˆì´ì…˜ ë„êµ¬

```java
@Component
public class DataMigrationService {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    public void migrateServiceData(String sourceServiceId, String targetServiceId) {
        // 1. ì†ŒìŠ¤ DBì—ì„œ ë°ì´í„° ì¶”ì¶œ
        ServiceContext.setCurrentServiceId(sourceServiceId);
        List<ContentDto> sourceData = contentService.getAllContents();

        // 2. íƒ€ê²Ÿ DBë¡œ ë°ì´í„° ì´ê´€
        ServiceContext.setCurrentServiceId(targetServiceId);
        sourceData.forEach(content -> {
            content.setId(null); // ID ì´ˆê¸°í™”
            contentService.createContent(content);
        });

        ServiceContext.clear();
    }

    public MigrationStatus checkMigrationStatus(String serviceId) {
        // ë§ˆì´ê·¸ë ˆì´ì…˜ ì§„í–‰ ìƒí™© í™•ì¸
        ServiceContext.setCurrentServiceId(serviceId);

        long totalRecords = contentRepository.count();
        long migratedRecords = contentRepository.countByMigrationStatus("MIGRATED");

        return new MigrationStatus(totalRecords, migratedRecords);
    }
}
```

## ğŸ”„ ì‹¤ì‹œê°„ ë°ì´í„° ë™ê¸°í™”

### 1. ë³€ê²½ ê°ì§€ ë° ë™ê¸°í™”

```java
@Entity
@EntityListeners(ChangeTrackingListener.class)
public class Content {
    // ê¸°ì¡´ í•„ë“œë“¤

    @Column(name = "sync_status")
    private String syncStatus = "PENDING"; // PENDING, SYNCED, FAILED

    @Column(name = "last_sync_at")
    private LocalDateTime lastSyncAt;
}

@Component
public class ChangeTrackingListener {

    @PostPersist
    @PostUpdate
    @PostRemove
    public void handleChange(Object entity) {
        if (entity instanceof SyncableEntity) {
            syncService.markForSync(entity);
        }
    }
}
```

### 2. ë°°ì¹˜ ë™ê¸°í™” ì‘ì—…

```java
@Component
public class DataSyncService {

    @Scheduled(fixedDelay = 60000) // 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
    public void syncPendingChanges() {
        List<String> activeServices = serviceRepository.findActiveServiceIds();

        for (String serviceId : activeServices) {
            ServiceContext.setCurrentServiceId(serviceId);

            // ë™ê¸°í™” ëŒ€ê¸° ì¤‘ì¸ ë°ì´í„° ì¡°íšŒ
            List<SyncableEntity> pendingEntities = findPendingSyncEntities();

            // í†µí•© DBë¡œ ë™ê¸°í™”
            for (SyncableEntity entity : pendingEntities) {
                try {
                    syncToIntegratedDb(entity);
                    markAsSynced(entity);
                } catch (Exception e) {
                    markAsFailed(entity, e.getMessage());
                }
            }

            ServiceContext.clear();
        }
    }
}
```

## ğŸ” ì•”í˜¸í™”ëœ ì—°ê²° ì •ë³´ ê´€ë¦¬

### 1. DB ì—°ê²° ì •ë³´ ì•”í˜¸í™”

```java
@Service
public class DatabaseConnectionService {

    @Value("${app.encryption.key}")
    private String encryptionKey;

    public String encryptConnectionInfo(DatabaseConnectionInfo info) {
        try {
            ObjectMapper mapper = new ObjectMapper();
            String jsonInfo = mapper.writeValueAsString(info);

            Cipher cipher = Cipher.getInstance("AES/GCM/NoPadding");
            SecretKeySpec keySpec = new SecretKeySpec(encryptionKey.getBytes(), "AES");
            cipher.init(Cipher.ENCRYPT_MODE, keySpec);

            byte[] encrypted = cipher.doFinal(jsonInfo.getBytes());
            return Base64.getEncoder().encodeToString(encrypted);
        } catch (Exception e) {
            throw new RuntimeException("Failed to encrypt connection info", e);
        }
    }

    public DatabaseConnectionInfo decryptConnectionInfo(String encryptedInfo) {
        try {
            byte[] encrypted = Base64.getDecoder().decode(encryptedInfo);

            Cipher cipher = Cipher.getInstance("AES/GCM/NoPadding");
            SecretKeySpec keySpec = new SecretKeySpec(encryptionKey.getBytes(), "AES");
            cipher.init(Cipher.DECRYPT_MODE, keySpec);

            byte[] decrypted = cipher.doFinal(encrypted);
            String jsonInfo = new String(decrypted);

            ObjectMapper mapper = new ObjectMapper();
            return mapper.readValue(jsonInfo, DatabaseConnectionInfo.class);
        } catch (Exception e) {
            throw new RuntimeException("Failed to decrypt connection info", e);
        }
    }
}
```

### 2. í™˜ê²½ë³„ ì„¤ì • ê´€ë¦¬

```yaml
# application-dev.yml
app:
  encryption:
    key: "dev-encryption-key-32-characters"
  database:
    integrated-cms:
      url: jdbc:mysql://localhost:3306/integrated_cms
      username: integrated.admin
      password: dev_password

# application-prod.yml
app:
  encryption:
    key: ${ENCRYPTION_KEY} # í™˜ê²½ë³€ìˆ˜ì—ì„œ ì½ê¸°
  database:
    integrated-cms:
      url: ${DB_URL}
      username: ${DB_USERNAME}
      password: ${DB_PASSWORD}
```

## ğŸ“‹ ë§ˆì´ê·¸ë ˆì´ì…˜ ì²´í¬ë¦¬ìŠ¤íŠ¸

### Phase 1: í™˜ê²½ ì¤€ë¹„

- [ ] integrated_cms DB ìƒì„±
- [ ] ê´€ë¦¬ì ê³„ì • ìƒì„± (integrated.admin, admin)
- [ ] ì•”í˜¸í™” í‚¤ ì„¤ì •
- [ ] ê¸°ë³¸ ìŠ¤í‚¤ë§ˆ ìƒì„±

### Phase 2: ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜

- [ ] ê¸°ì¡´ ì‚¬ìš©ì ë°ì´í„° â†’ ADMIN_USER ì´ê´€
- [ ] ì„œë¹„ìŠ¤ ì •ë³´ ë“±ë¡
- [ ] ê¶Œí•œ ë§¤í•‘ ì„¤ì •
- [ ] ë°ì´í„° ê²€ì¦

### Phase 3: ë™ì  ë¼ìš°íŒ… ì ìš©

- [ ] DynamicDataSource ì„¤ì •
- [ ] ServiceContext êµ¬í˜„
- [ ] ê¸°ì¡´ Service Layer í…ŒìŠ¤íŠ¸
- [ ] v2 API ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„

### Phase 4: ì•ˆì •í™”

- [ ] ë™ê¸°í™” ì‹œìŠ¤í…œ êµ¬ì¶•
- [ ] ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ ì—°ë™
- [ ] ë°±ì—…/ë³µêµ¬ ê³„íš ìˆ˜ë¦½
- [ ] ì„±ëŠ¥ ìµœì í™”
