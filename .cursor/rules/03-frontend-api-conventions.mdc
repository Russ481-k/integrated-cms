---
globs: *.ts,*.tsx,*.js,*.jsx
description: í”„ë¡ íŠ¸ì—”ë“œ API í†µì‹  ë° ê°œë°œ ì»¨ë²¤ì…˜
---

# í”„ë¡ íŠ¸ì—”ë“œ API í†µì‹  ì»¨ë²¤ì…˜

## ğŸ› ï¸ ê¸°ìˆ  ìŠ¤íƒ

### Core Framework

- **Next.js 14** (App Router)
- **React 18** + TypeScript 5.x
- **Chakra UI** + **TanStack Query** + **Zustand**
- **React Hook Form** + **Chart.js/Recharts**

## ğŸ“¡ API í´ë¼ì´ì–¸íŠ¸ êµ¬ì¡°

### ê¸°ë³¸ í´ë¼ì´ì–¸íŠ¸ ì„¤ì •

```typescript
// lib/api/client.ts ê¸°ë°˜
import { publicApi, privateApi } from "@/lib/api/client";

// ê³µê°œ API (ì¸ì¦ ë¶ˆí•„ìš”)
const response = await publicApi.get<UserSignupResponse>("/auth/signup");

// ì¸ì¦ API (JWT í† í° ìë™ í¬í•¨)
const response = await privateApi.get<UserProfile>("/user/profile");
```

### API ì‘ë‹µ íƒ€ì… ì •ì˜

```typescript
// ë°±ì—”ë“œ ApiResponseSchemaì™€ ì¼ì¹˜í•˜ëŠ” êµ¬ì¡°
export interface ApiResponse<T = any> {
  success: boolean;
  message?: string;
  data?: T;
  errorCode?: string | null;
  stackTrace?: string | null;
}

// ì‚¬ìš© ì˜ˆì‹œ
export interface UserApiResponse extends ApiResponse<User> {}
export interface MenuApiResponse extends ApiResponse<Menu[]> {}
```

## ğŸ” ì¸ì¦ ë° í† í° ê´€ë¦¬

### JWT í† í° ìë™ ê´€ë¦¬

```typescript
// privateApiëŠ” ìë™ìœ¼ë¡œ JWT í† í°ì„ í—¤ë”ì— í¬í•¨
// 401 ì‘ë‹µ ì‹œ ìë™ í† í° ê°±ì‹  ì‹œë„
// ê°±ì‹  ì‹¤íŒ¨ ì‹œ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸

// í† í° ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
import { getToken, setToken, removeToken } from "@/lib/auth-utils";

// API í˜¸ì¶œ ì‹œ ìë™ ì¸ì¦ ì²˜ë¦¬
const userProfile = await privateApi.get<User>("/user/me");
```

### ì¸ì¦ ì—ëŸ¬ ì²˜ë¦¬

```typescript
// withAuthRedirect HOF ì‚¬ìš©
import { withAuthRedirect } from "@/lib/api/withAuthRedirect";

const getUserProfile = withAuthRedirect(async () => {
  return await privateApi.get<User>("/user/profile");
});

// 401 ì—ëŸ¬ ì‹œ ìë™ìœ¼ë¡œ:
// 1. í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ
// 2. í˜„ì¬ ê²½ë¡œ ì €ì¥
// 3. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
```

## ğŸ“‹ API í˜¸ì¶œ íŒ¨í„´

### í‘œì¤€ CRUD íŒ¨í„´ (í†µí•© ë°±ì—”ë“œ ë¼ìš°íŒ…)

```typescript
// services/contentApi.ts
export const contentApi = {
  // ëª©ë¡ ì¡°íšŒ
  getContents: async (
    serviceId: string,
    params?: PaginationParams
  ): Promise<Page<Content>> => {
    return await privateApi.get<Page<Content>>(
      `/api/v2/cms/${serviceId}/content`,
      { params }
    );
  },

  // ë‹¨ì¼ ì¡°íšŒ
  getContent: async (serviceId: string, id: number): Promise<Content> => {
    return await privateApi.get<Content>(
      `/api/v2/cms/${serviceId}/content/${id}`
    );
  },

  // ìƒì„±
  createContent: async (
    serviceId: string,
    data: CreateContentRequest
  ): Promise<Content> => {
    return await privateApi.post<Content>(`/api/v2/${serviceId}/content`, data);
  },

  // ìˆ˜ì •
  updateContent: async (
    serviceId: string,
    id: number,
    data: UpdateContentRequest
  ): Promise<Content> => {
    return await privateApi.put<Content>(
      `/api/v2/${serviceId}/content/${id}`,
      data
    );
  },

  // ì‚­ì œ
  deleteContent: async (serviceId: string, id: number): Promise<void> => {
    await privateApi.delete(`/api/v2/cms/${serviceId}/content/${id}`);
  },
};

// í†µí•© ê´€ë¦¬ API (integrated_cms DB ì ‘ê·¼)
export const integratedCmsApi = {
  // í†µí•© ê´€ë¦¬ì ëª©ë¡ ì¡°íšŒ
  getAdminUsers: async (): Promise<AdminUser[]> => {
    return await privateApi.get<AdminUser[]>("/api/v2/integrated-cms/admins");
  },

  // ì‹œìŠ¤í…œ ê¶Œí•œ ì¡°íšŒ
  getPermissions: async (): Promise<Permission[]> => {
    return await privateApi.get<Permission[]>(
      "/api/v2/integrated-cms/permissions"
    );
  },

  // ì„œë¹„ìŠ¤ ëª©ë¡ ì¡°íšŒ
  getServices: async (): Promise<Service[]> => {
    return await privateApi.get<Service[]>("/api/v2/integrated-cms/services");
  },

  // ì„œë¹„ìŠ¤ ìƒì„±
  createService: async (data: CreateServiceRequest): Promise<Service> => {
    return await privateApi.post<Service>(
      "/api/v2/integrated-cms/services",
      data
    );
  },

  // ê´€ë¦¬ì ìƒì„±
  createAdmin: async (data: CreateAdminRequest): Promise<AdminUser> => {
    return await privateApi.post<AdminUser>(
      "/api/v2/integrated-cms/admins",
      data
    );
  },

  // ê´€ë¦¬ì ê¶Œí•œ ì—…ë°ì´íŠ¸
  updateAdminPermissions: async (
    adminId: string,
    data: UpdatePermissionsRequest
  ): Promise<AdminUser> => {
    return await privateApi.put<AdminUser>(
      `/api/v2/integrated-cms/admins/${adminId}/permissions`,
      data
    );
  },
};
```

### TanStack Query ì‚¬ìš© íŒ¨í„´

```typescript
// hooks/useContent.ts
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";

export const useContents = (serviceId: string, params?: PaginationParams) => {
  return useQuery({
    queryKey: ["contents", serviceId, params],
    queryFn: () => contentApi.getContents(serviceId, params),
    enabled: !!serviceId,
  });
};

export const useCreateContent = (serviceId: string) => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (data: CreateContentRequest) =>
      contentApi.createContent(serviceId, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["contents", serviceId] });
      toast.success("ì½˜í…ì¸ ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");
    },
    onError: (error) => {
      toast.error(error.message || "ì½˜í…ì¸  ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    },
  });
};
```

## ğŸ­ ìƒíƒœ ê´€ë¦¬ íŒ¨í„´

### Zustand ìŠ¤í† ì–´ êµ¬ì¡°

```typescript
// stores/authStore.ts
interface AuthState {
  user: User | null;
  serviceId: string | null;
  isAuthenticated: boolean;
  setUser: (user: User | null) => void;
  setServiceId: (serviceId: string) => void;
  logout: () => void;
}

export const useAuthStore = create<AuthState>((set) => ({
  user: null,
  serviceId: null,
  isAuthenticated: false,
  setUser: (user) => set({ user, isAuthenticated: !!user }),
  setServiceId: (serviceId) => set({ serviceId }),
  logout: () => {
    removeToken();
    set({ user: null, serviceId: null, isAuthenticated: false });
  },
}));
```

### ì„œë¹„ìŠ¤ ì»¨í…ìŠ¤íŠ¸ ê´€ë¦¬

```typescript
// hooks/useServiceContext.ts
export const useServiceContext = () => {
  const { serviceId } = useAuthStore();
  const router = useRouter();

  const switchService = useCallback(
    (newServiceId: string) => {
      useAuthStore.getState().setServiceId(newServiceId);
      router.push(`/services/${newServiceId}/dashboard`);
    },
    [router]
  );

  return { serviceId, switchService };
};
```

## ğŸ“ í¼ ê´€ë¦¬ ë° ê²€ì¦

### React Hook Form íŒ¨í„´

```typescript
// hooks/useContentForm.ts
interface ContentFormData {
  title: string;
  content: string;
  status: ContentStatus;
  tags: string[];
}

export const useContentForm = (initialData?: Partial<Content>) => {
  const form = useForm<ContentFormData>({
    defaultValues: {
      title: initialData?.title || "",
      content: initialData?.content || "",
      status: initialData?.status || ContentStatus.DRAFT,
      tags: initialData?.tags || [],
    },
    resolver: zodResolver(contentSchema),
  });

  return form;
};

// Zod ìŠ¤í‚¤ë§ˆ ê²€ì¦
const contentSchema = z.object({
  title: z
    .string()
    .min(1, "ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
    .max(100, "ì œëª©ì€ 100ì ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤."),
  content: z.string().min(1, "ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."),
  status: z.nativeEnum(ContentStatus),
  tags: z.array(z.string()).max(10, "íƒœê·¸ëŠ” ìµœëŒ€ 10ê°œê¹Œì§€ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."),
});
```

## ğŸš¨ ì—ëŸ¬ ì²˜ë¦¬ ë° ì‚¬ìš©ì í”¼ë“œë°±

### ì—ëŸ¬ ì²˜ë¦¬ ê³„ì¸µ

```typescript
// utils/errorHandler.ts
export const handleApiError = (error: unknown) => {
  if (error instanceof AxiosError) {
    const apiError = error.response?.data as ApiResponse;

    // ë°±ì—”ë“œ ì—ëŸ¬ ë©”ì‹œì§€ ìš°ì„  ì‚¬ìš©
    const message =
      apiError?.message || error.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";

    switch (error.response?.status) {
      case 400:
        toast.error(`ì˜ëª»ëœ ìš”ì²­: ${message}`);
        break;
      case 401:
        // withAuthRedirectì—ì„œ ì²˜ë¦¬
        break;
      case 403:
        toast.error("ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
        break;
      case 404:
        toast.error("ìš”ì²­í•œ ë¦¬ì†ŒìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        break;
      case 500:
        toast.error("ì„œë²„ ë‚´ë¶€ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        break;
      default:
        toast.error(message);
    }
  }
};
```

### ë¡œë”© ìƒíƒœ ê´€ë¦¬

```typescript
// hooks/useApiState.ts
export const useApiState = <T>() => {
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [data, setData] = useState<T | null>(null);

  const execute = useCallback(async (apiCall: () => Promise<T>) => {
    setIsLoading(true);
    setError(null);

    try {
      const result = await apiCall();
      setData(result);
      return result;
    } catch (err) {
      const message = err instanceof Error ? err.message : "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜";
      setError(message);
      handleApiError(err);
      throw err;
    } finally {
      setIsLoading(false);
    }
  }, []);

  return { isLoading, error, data, execute };
};
```

## ğŸ¨ UI ì»´í¬ë„ŒíŠ¸ íŒ¨í„´

### ê³µí†µ ì»´í¬ë„ŒíŠ¸ êµ¬ì¡°

```typescript
// components/common/DataTable.tsx
interface DataTableProps<T> {
  data: T[];
  columns: ColumnDef<T>[];
  isLoading?: boolean;
  onRowClick?: (row: T) => void;
  pagination?: PaginationProps;
}

export const DataTable = <T>({
  data,
  columns,
  isLoading,
  onRowClick,
  pagination,
}: DataTableProps<T>) => {
  // AG Grid ë˜ëŠ” TanStack Table ì‚¬ìš©
  return (
    <Box>
      {isLoading ? <Spinner /> : <Table data={data} columns={columns} />}
      {pagination && <Pagination {...pagination} />}
    </Box>
  );
};
```

### í¼ ì»´í¬ë„ŒíŠ¸ íŒ¨í„´

```typescript
// components/forms/ContentForm.tsx
interface ContentFormProps {
  serviceId: string;
  initialData?: Content;
  onSubmit: (data: ContentFormData) => void;
  isLoading?: boolean;
}

export const ContentForm: React.FC<ContentFormProps> = ({
  serviceId,
  initialData,
  onSubmit,
  isLoading,
}) => {
  const form = useContentForm(initialData);

  return (
    <form onSubmit={form.handleSubmit(onSubmit)}>
      <VStack spacing={4}>
        <FormControl isInvalid={!!form.formState.errors.title}>
          <FormLabel>ì œëª©</FormLabel>
          <Input {...form.register("title")} />
          <FormErrorMessage>
            {form.formState.errors.title?.message}
          </FormErrorMessage>
        </FormControl>

        <Button type="submit" isLoading={isLoading}>
          ì €ì¥
        </Button>
      </VStack>
    </form>
  );
};
```

## ğŸ”„ ì‹¤ì‹œê°„ ë°ì´í„° ë™ê¸°í™”

### WebSocket ì—°ê²° ê´€ë¦¬

```typescript
// hooks/useWebSocket.ts
export const useWebSocket = (serviceId: string) => {
  const [socket, setSocket] = useState<WebSocket | null>(null);
  const [connectionStatus, setConnectionStatus] = useState<
    "connecting" | "connected" | "disconnected"
  >("disconnected");

  useEffect(() => {
    const ws = new WebSocket(`ws://localhost:8080/ws/${serviceId}`);

    ws.onopen = () => setConnectionStatus("connected");
    ws.onclose = () => setConnectionStatus("disconnected");
    ws.onmessage = (event) => {
      // ì‹¤ì‹œê°„ ë°ì´í„° ì²˜ë¦¬
      const data = JSON.parse(event.data);
      // TanStack Query ìºì‹œ ë¬´íš¨í™”
      queryClient.invalidateQueries({ queryKey: ["realtime", serviceId] });
    };

    setSocket(ws);
    return () => ws.close();
  }, [serviceId]);

  return { socket, connectionStatus };
};
```
